Summary:        quasardb web bridge
Name:           $PACKAGE_NAME
Version:        $PACKAGE_VERSION
Release:        1
License:        Proprietary
Group:          Applications/Databases
Vendor:         quasardb SAS
Prefix:         /usr
URL:            https://www.quasardb.net/
BuildArch:      x86_64
Source0:        $PACKAGE_TARBALL
Source1:        qdb_httpd_init.sh
Requires(pre):    /usr/sbin/useradd, /usr/sbin/groupadd
Requires(postun): /usr/sbin/userdel


%description
quasardb web bridge


%prep
%setup -c


%install
# /var/log/qdb_httpd/
mkdir -p                   %{buildroot}%{_localstatedir}/log/qdb_http

# /etc/qdb/
mkdir -p                   %{buildroot}%{_sysconfdir}/qdb

# /usr/share/qdb/www/
mkdir -p                   %{buildroot}%{_datadir}
cp -r       share/qdb      %{buildroot}%{_datadir}

# /etc/init/qdb_http
mkdir -p                   %{buildroot}%{_initddir}
cp          %{SOURCE1}     %{buildroot}%{_initddir}/qdb_httpd

# /usr/bin/qdb_httpd
mkdir -p                   %{buildroot}%{_bindir}
cp          bin/*          %{buildroot}%{_bindir}


%files
%defattr(644,root,root,755)

%{_datadir}/qdb/www

%attr(755, root, root)            %dir     %{_sysconfdir}/qdb
%attr(750, qdb, qdb)    %dir     %{_localstatedir}/log/qdb_http

%attr(755, root, root)            %{_bindir}/*
%attr(755, root, root)            %{_initddir}/qdb_httpd                         %config(noreplace)


%pre
case "$1" in
    1) # initial install
        /usr/bin/getent group  qdb >/dev/null || /usr/sbin/groupadd -r -f qdb
        /usr/bin/getent passwd qdb >/dev/null || /usr/sbin/useradd -g qdb -r -s /sbin/nologin qdb
    ;;
    2) # upgrade, do nothing
      :
    ;;
esac

%post
# add user for qdb_httpd
if [ ! -e %{_sysconfdir}/qdb/qdb_httpd_private.key ]; then
    %{_bindir}/qdb_user_add -u qdb_httpd -p %{_sysconfdir}/qdb/users.conf -s %{_sysconfdir}/qdb/qdb_httpd_private.key
    chown qdb:qdb %{_sysconfdir}/qdb/qdb_httpd_private.key
    chmod 0600 %{_sysconfdir}/qdb/qdb_httpd_private.key
fi

# need to generate the configuration
# does not overwrite existing files
[ -e %{_sysconfdir}/qdb/qdb_httpd.conf ] || %{_bindir}/qdb_httpd --gen-config --cluster-public-key-file=%{_localstatedir}/share/qdb/cluster_public.key --user-credentials-file=%{_sysconfdir}/qdb/qdb_httpd_private.key --daemonize --log-directory=%{_localstatedir}/log/qdb_http --root=%{_datadir}/qdb/www > %{_sysconfdir}/qdb/qdb_httpd.conf

case "$1" in
    1) # initial install
        chkconfig --add qdb_httpd
        service qdb_httpd start
    ;;
    2) # upgrade, just run the service
        service qdb_httpd start
    ;;
esac

%preun
case "$1" in
    0) # uninstall
        service qdb_httpd stop
        chkconfig --del qdb_httpd
    ;;
    1) # upgrade, just stop the service
        service qdb_httpd stop
    ;;
esac

%postun
case "$1" in
    0) # uninstall
        if ! type qdbd > /dev/null ; then
            /usr/sbin/userdel -f qdb
        fi
    ;;
    1) # upgrade, do nothing
      :
    ;;
esac
