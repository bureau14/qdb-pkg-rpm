Buildroot:      @QDB_OUTPUT_DIRECTORY@/RPM
Summary:        @CPACK_PACKAGE_DESCRIPTION_SUMMARY@
Name:           qdb
Version:        @CPACK_PACKAGE_VERSION@
Release:        2
License:        Proprietary
Group:          Applications/Databases
Vendor:         @CPACK_PACKAGE_VENDOR@
Prefix:         /usr
URL:            @CPACK_RPM_PACKAGE_URL@
BuildArch:      @CPACK_RPM_PACKAGE_ARCHITECTURE@

%description
@CPACK_PACKAGE_DESCRIPTION_SUMMARY@

This meta package will install: the documentation, the server, the client utilities and the C/C++ API

%prep

rm -rf          $RPM_BUILD_ROOT
mkdir -p        $RPM_BUILD_ROOT
rm -rf          %_rpmdir
mkdir -p        %_rpmdir

%build

# create a layout in RPM_BUILD_ROOT, each module will then pick the files it needs from this layout
%install

# server stuff
mkdir -p        $RPM_BUILD_ROOT%{_localstatedir}/db/qdb

mkdir -p        $RPM_BUILD_ROOT%{_localstatedir}/log/qdb

touch           $RPM_BUILD_ROOT%{_localstatedir}/log/qdb/qdbd.log
touch           $RPM_BUILD_ROOT%{_localstatedir}/log/qdb/qdb_httpd.log

mkdir -p        $RPM_BUILD_ROOT%{_localstatedir}/run/qdb

mkdir -p        $RPM_BUILD_ROOT%{_sysconfdir}/qdb
mkdir -p        $RPM_BUILD_ROOT%{_initddir}

mkdir -p        $RPM_BUILD_ROOT%{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/console

cp -r           @CMAKE_SOURCE_DIR@/qdb/backend/gui/admin/*               $RPM_BUILD_ROOT%{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/console

rm -rf          $RPM_BUILD_ROOT%{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/console/mocks
rm              $RPM_BUILD_ROOT%{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/console/README.md

touch           $RPM_BUILD_ROOT%{_sysconfdir}/qdb/qdb_license.txt

#install -m 644  @CMAKE_SOURCE_DIR@/scripts/packaging/rpm/qdbd.conf       $RPM_BUILD_ROOT%{_sysconfdir}/qdb/qdbd.conf
#install -m 644  @CMAKE_SOURCE_DIR@/scripts/packaging/rpm/qdb_httpd.conf  $RPM_BUILD_ROOT%{_sysconfdir}/qdb/qdb_httpd.conf
install -m 644  @CMAKE_SOURCE_DIR@/scripts/packaging/rpm/qdbd.sh         $RPM_BUILD_ROOT%{_initddir}/qdbd
install -m 644  @CMAKE_SOURCE_DIR@/scripts/packaging/rpm/qdb_httpd.sh    $RPM_BUILD_ROOT%{_initddir}/qdb_httpd

mkdir -p        $RPM_BUILD_ROOT%{_sbindir}
mkdir -p        $RPM_BUILD_ROOT%{_bindir}

# configuration generator
install -m 755  @QDB_OUTPUT_DIRECTORY@/qdb_generate_config             $RPM_BUILD_ROOT%{_bindir}/qdb_generate_config

# servers
install -m 755  @QDB_OUTPUT_DIRECTORY@/qdbd                            $RPM_BUILD_ROOT%{_sbindir}/qdbd
install -m 755  @QDB_OUTPUT_DIRECTORY@/qdb_httpd                       $RPM_BUILD_ROOT%{_sbindir}/qdb_httpd

# client stuff
mkdir -p        $RPM_BUILD_ROOT%{_bindir}

install -m 755  @QDB_OUTPUT_DIRECTORY@/qdbsh                           $RPM_BUILD_ROOT%{_bindir}/qdbsh
install -m 755  @QDB_OUTPUT_DIRECTORY@/qdb_bench                       $RPM_BUILD_ROOT%{_bindir}/qdb_bench
install -m 755  @QDB_OUTPUT_DIRECTORY@/qdb_dbtool                      $RPM_BUILD_ROOT%{_bindir}/qdb_dbtool
install -m 755  @QDB_OUTPUT_DIRECTORY@/qdb_max_conn                    $RPM_BUILD_ROOT%{_bindir}/qdb_max_conn

install -m 755  @QDB_OUTPUT_DIRECTORY@/leveldbutil                     $RPM_BUILD_ROOT%{_bindir}/leveldbutil

# C/C++ API stuff
mkdir -p        $RPM_BUILD_ROOT%{_includedir}/@CPACK_PACKAGE_NAME@
mkdir -p        $RPM_BUILD_ROOT%{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/examples/c
mkdir -p        $RPM_BUILD_ROOT%{_libdir}

install -m 755  @QDB_OUTPUT_DIRECTORY@/libqdb_api.so                   $RPM_BUILD_ROOT%{_libdir}/libqdb_api-@CPACK_PACKAGE_VERSION@.so

install -m 644  @CMAKE_SOURCE_DIR@/qdb/api/include/qdb/*.h          $RPM_BUILD_ROOT%{_includedir}/@CPACK_PACKAGE_NAME@
install -m 644  @CMAKE_SOURCE_DIR@/qdb/api/include/qdb/*.hpp        $RPM_BUILD_ROOT%{_includedir}/@CPACK_PACKAGE_NAME@

install -m 644  @CMAKE_SOURCE_DIR@/qdb/example/c/*.c                   $RPM_BUILD_ROOT%{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/examples/c

%files 

%package server
Summary: quasardb daemons
Group: Applications/Databases
Requires(pre): /usr/sbin/useradd, /usr/sbin/groupadd
Requires(postun): /usr/sbin/userdel

%description server
quasardb daemons

%pre server
/usr/bin/getent group  qdb || /usr/sbin/groupadd -r -f qdb
/usr/bin/getent passwd qdb || /usr/sbin/useradd -g qdb -r -s /sbin/nologin -d /var/empty/qdb qdb

%post server

# need to generate the configuration
# parameters: [config path] [log path] [db path] [console path]
# does not overwrite existing files
%{_bindir}/qdb_generate_config %{_sysconfdir}/qdb %{_localstatedir}/log/qdb %{_localstatedir}/db/qdb %{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/console

chkconfig --add qdbd
chkconfig --add qdb_httpd

%preun

service qdb_httpd stop
service qdbd stop

chkconfig --del qdb_httpd
chkconfig --del qdbd

%postun server

/usr/sbin/userdel -f qdb

%files server
%defattr(644,root,root,755)

%attr(755, root, root) %{_bindir}/qdb_generate_config

%attr(755, root, root) %{_sbindir}/qdbd
%attr(755, root, root) %{_sbindir}/qdb_httpd

%attr(755, qdb, qdb) %dir %{_localstatedir}/db/qdb
%attr(755, qdb, qdb) %dir %{_localstatedir}/run/qdb
%attr(755, qdb, qdb) %dir %{_localstatedir}/log/qdb

%{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/console

# prevent log overwrite during an upgrade
%attr(640, qdb, qdb) %config(noreplace)   %{_localstatedir}/log/qdb/qdbd.log
%attr(640, qdb, qdb) %config(noreplace)   %{_localstatedir}/log/qdb/qdb_httpd.log

%attr(640, qdb, qdb) %config(noreplace)   %{_sysconfdir}/qdb/qdb_license.txt

%attr(755, root, root) %config(noreplace) %{_initddir}/qdbd
%attr(755, root, root) %config(noreplace) %{_initddir}/qdb_httpd

%package utils
Summary: quasardb client utilities
Group: Applications/Databases

%description utils
quasardb client utilities

mkdir -p $RPM_BUILD_ROOT

%pre utils

%post utils

%postun utils

%files utils
%defattr(755,root,root,755)

%{_bindir}/qdbsh
%{_bindir}/qdb_bench
%{_bindir}/qdb_dbtool
%{_bindir}/qdb_max_conn

%{_bindir}/leveldbutil

%package api
Summary: quasardb C/C++ APIs
Group: Applications/Databases

%description api
Includes C/C++ API

%pre api

%post api
ldconfig

ln -s -f %{_libdir}/libqdb_api-@CPACK_PACKAGE_VERSION@.so   %{_libdir}/libqdb_api.so 
ln -s -f %{_includedir}/@CPACK_PACKAGE_NAME@                %{_includedir}/qdb

%postun api

%files api
%defattr(644,root,root,755)

%attr(755, root, root) %{_libdir}/libqdb_api-@CPACK_PACKAGE_VERSION@.so

%{_includedir}/@CPACK_PACKAGE_NAME@/*.h
%{_includedir}/@CPACK_PACKAGE_NAME@/*.hpp

%{_datadir}/qdb/@CPACK_PACKAGE_VERSION@/examples/c

%changelog
* Wed Sep 9 2015 Marek <none@quasardb.net> 2.0
- add missing include files
* Thu Feb 19 2014 Edouard <none@quasardb.net> 2.0
- first version 
